CONV_BOUNDARY_DETECTION_PROMPT = """
### 核心任务
作为一名对话分析专家，你需要判断新传入的消息是否为一个已有对话“情节”的自然结尾。目标是将连续的对话流分割成有意义的、可独立记忆的片段（MemCell）。你的核心原则是 **“默认合并，谨慎切分”**。

### 对话上下文
**已有对话历史:**
```
{conversation_history}
```

**与上一条消息的时间间隔:**
`{time_gap_info}`

**新传入的消息:**
```
{new_messages}
```

### 决策变量详解
你需要输出三个关键决策变量：`should_end`, `should_wait`, 和 `topic_summary`。

1.  **`should_end` (结束当前情节):**
    -   **何时设为 `true`?** 仅当新消息明确开启一个与之前历史无关的新主题时。一个用于总结或收尾当前主题的消息（如“迁移完成了”）应被归入当前情节，而不是作为新情节的开始。
    -   **触发场景示例:**
        -   **跨天强制切分:** 只要新消息与上一条消息的日期不同（例如，从“昨天”到“今天”），就必须切分。这是最高优先级的规则。
        -   **主题切换:** 对话从“讨论项目A的技术细节”突然转向“周末去哪里玩”。
        -   **任务完成并开启新篇:** 一个任务的收尾消息（如“仓库迁移好了”）属于该任务的情节。只有当**下一条**消息开启了完全不相关的新话题时，才在那条新消息处切分。
        -   **长时间中断后开启新话题:** 时间间隔超过4小时，且新消息内容与历史对话无明显关联。
        

2.  **`should_wait` (等待更多信息):**
    -   **何时设为 `true`?** 当新消息**信息量不足**，无法判断其是否延续当前话题时。这是一个**安全选项**，用于避免在上下文不充分时草率地分割或合并对话。
    -   **此为默认行为，在以下情况必须设为 `true`:**
        -   **非文本消息:** 新消息仅为 `[图片]`, `[视频]`, `[文件]` 等占位符，没有附带任何可用于判断意图的文字。
        -   **无明确意图的短回复:** 新消息是极为简短的回应，如“好的”, “嗯”, “收到”, “lol”, “😂”。
        -   **系统或非对话消息:** 新消息是系统通知（如邀请、入群、退群）、转账提示等。**这类消息本身不提供足够信息来判断情节边界，必须等待后续的人类消息再做决策。**
        -   **不确定的中间状态:** 时间间隔在30分钟到4小时之间，且新消息内容模糊，既不像强延续，也不像强开启。

3.  **`topic_summary` (情节主题总结):**
    -   **何时生成?** 仅在 `should_end` 被设为 `true` 时。
    -   **内容要求:** 用一句话精准、客观地概括**即将结束的这个情节**的核心内容。例如：“确定项目A的最终技术方案”或“讨论并确认了周末的团队活动安排”。

### 决策指导原则
- **内容优先于形式:** 优先保证每个情节都包含一个完整、有价值的核心信息。不要被简单的问候语（“你好”）或结束语（“再见”）迷惑，它们应被归入其所服务的主要情节中。
- **合并是默认倾向:** 如果不确定，倾向于不切分 (`should_end: false`)。只有在看到明确的切分信号时才进行分割。
- **关注因果与流程连贯性:** 如果新消息是前序动作（如建群、添加成员）的直接目标或结果（如在群里发布第一条项目指令），应将它们合并成一个完整的情节。不要在连续的流程中间断开。
- **`should_end` 与 `should_wait` 互斥:** 如果 `should_end` 是 `true`，`should_wait` 必须是 `false`。如果 `should_wait` 是 `true`，`should_end` 必须是 `false`。
- **考虑上下文连贯性:** 将那些为了同一个小目标服务的、连续的、短时间内的“来回”对话视为一个整体。
- **系统消息的上下文相关性:** 不要将系统消息（如“[用户X]加入了群聊”）默认为话题切换的信号。它的意义由下一条人类消息决定。例如，如果下一条消息是“欢迎！我们刚才正讨论到...”，则应合并；如果下一条消息开启了全新话题，则可考虑切分。

### 输出格式
请严格按照以下JSON格式返回你的分析结果：
```json
{{
    "reasoning": "一句话解释你为什么做出 should_end 和 should_wait 的决策。",
    "should_end": boolean,
    "should_wait": boolean,
    "confidence": float,
    "topic_summary": "仅在 should_end 为 true 时填写。总结已结束情节的主题，否则为空字符串。"
}}
```"""

CONV_SUMMARY_PROMPT = """
你是一位专业的对话总结师。请根据以下对话内容，用一句话客观、精炼地总结其核心主题。
"""
